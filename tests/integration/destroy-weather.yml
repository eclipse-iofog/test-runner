---
- config:
  - testset: "Destroying Weather App to Iofog"
  - timeout: 600000 # 10 seconds
  - generators:
     - 'userEmail': {type: 'env_variable', variable_name: 'CONTROLLER_EMAIL'}
     - 'userPassword': {type: 'env_variable', variable_name: 'CONTROLLER_PASSWORD'}

- test:
      - name: "Login"
      - group: "Destroy Weather Microservice"
      - url: "/api/v3/user/login"
      - headers: {'Content-Type': 'application/json'}
      - generator_binds: {userEmail: userEmail, userPassword: userPassword}
      - body: {template: '{"email":"$userEmail","password":"$userPassword"}'}
      - method: "POST"
      - expected_status: [200]
      - extract_binds:
        - 'accessToken': {'jsonpath_mini': 'accessToken'}

- test:
      - name: "Get flows"
      - group: "Destroy Weather Microservice"
      - url: "/api/v3/flow"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]
      - extract_binds:
        - 'flowID': {'jmespath': "flows[?name=='test-flow'].id | [0]"}

- test:
      - name: "Get Microservice UUID"
      - group: "Destroy Weather Microservice"
      - url: {template: "/api/v3/microservices?flowId=$flowID"}
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]
      - extract_binds:
        - 'firstUUID': {'jsonpath_mini': {template: "microservices.0.uuid"}}
        - 'secondUUID': {'jsonpath_mini': {template: "microservices.1.uuid"}}

- test:
      - name: "Delete microservice"
      - group: "Destroy Weather Microservice"
      - url: {template: "/api/v3/microservices/$firstUUID"}
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "DELETE"
      - body: '{"withCleanup": true}'
      - expected_status: [204]

- test:
      - name: "Delete microservice"
      - group: "Destroy Weather Microservice"
      - url: {template: "/api/v3/microservices/$secondUUID"}
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "DELETE"
      - body: '{"withCleanup": true}'
      - expected_status: [204]

- test:
      - name: "Logout"
      - group: "Destroy Weather Microservice"
      - url: "/api/v3/user/logout"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "POST"
      - expected_status: [204]
